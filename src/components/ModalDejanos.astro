---
import { Image } from "astro:assets";
interface Props {
  id: string;
  idClose: string;
}

const { id, idClose } = Astro.props;

import imgContact from "../../public/assets/img/webp/img_dejanos.webp";
---

<div
  id={id}
  class="fixed hidden inset-0 z-50 transform transition-all duration-300 ease-in-out"
>
  <!-- Overlay con fade -->
  <div
    class="fixed inset-0 bg-black opacity-0 transition-opacity duration-300 ease-in-out modal-backdrop"
  >
  </div>

  <!-- Container del Modal -->
  <div class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4 text-center">
      <!-- Modal Content con slide y fade -->
      <div
        class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all duration-300 ease-in-out opacity-0 translate-y-4 sm:translate-y-0 modal-content w-full max-w-[700px]"
      >
        <div class="flex items-center justify-between p-5">
          <button
            type="button"
            class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
            id={idClose}
          >
            <svg
              class="w-3 h-3"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 14 14"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"></path>
            </svg>
            <span class="sr-only">Close modal</span>
          </button>
        </div>
        <div class="w-full flex flex-col md:flex-row p-5 pt-0">
          <form class="p-4 pt-0 md:p-5 md:pt-0 w-full md:w-1/2 space-y-5">
            <h2 class="text-lg font-semibold text-gray-900">
              DÉJANOS CONTACTARTE
            </h2>
            <div class="col-span-2 pt-5">
              <label
                for="name"
                class="block mb-2 text-sm font-medium text-gray-900"
                >Nombre</label
              >
              <input
                type="text"
                name="name"
                id="name"
                autocomplete="name"
                class="bg-[#FCFCFC] border border-black text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
                placeholder=""
                required={true}
              />
            </div>
            <div class="col-span-2">
              <label
                for="email"
                class="block mb-2 text-sm font-medium text-gray-900"
                >Correo</label
              >
              <input
                type="email"
                name="email"
                id="email"
                class="bg-[#FCFCFC] border border-black text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
                placeholder=""
                required={true}
              />
            </div>
            <div class="col-span-2">
              <label
                for="cellphone"
                class="block mb-2 text-sm font-medium text-gray-900"
                >Celular</label
              >
              <input
                type="tel"
                name="cellphone"
                id="cellphone"
                autocomplete="tel"
                inputmode="numeric"
                pattern="[0-9]*"
                class="bg-[#FCFCFC] border border-black text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5"
                placeholder=""
                required={true}
                style="-moz-appearance: textfield; /* Firefox */
                        -webkit-appearance: none; /* Safari and Chrome */
                      margin: 0;"
              />
            </div>
            <div class="col-span-2">
              <label
                for="message"
                class="block mb-2 text-sm font-medium text-gray-900"
                >¿Por cuál medio prefieres que te contactemos?</label
              >
              <div class="relative">
                <select
                  id="contactMethod"
                  name="contactMethod"
                  class="bg-[#FCFCFC] border border-black text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 w-full p-2.5 pr-10 appearance-none"
                  required
                >
                  <option value="" disabled selected
                    >Selecciona una opción</option
                  >
                  <option value="email">Correo electrónico</option>
                  <option value="phone">Teléfono</option>
                  <option value="whatsapp">WhatsApp</option>
                </select>
                <div
                  class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="w-6 h-6 text-[#8647EA] hover:text-[#6d34c7]"
                    viewBox="0 0 20 20"
                    fill="currentColor"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M5.293 8.707a1 1 0 011.414 0L10 11.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                      clip-rule="evenodd"></path>
                  </svg>
                </div>
              </div>
            </div>
            <button
              type="submit"
              class="text-white mt-5 w-[200px] inline-flex items-center justify-center bg-[#8647EA] hover:bg-[#6d34c7] focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium text-sm px-5 py-2.5 text-center"
            >
              Enviar
            </button>
          </form>

          <!-- mensaje oculto para que cuando se envie el formulario se muestre -->
          <div
            id="success-message"
            class="opacity-0 pointer-events-none fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300"
          >
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-4">
              <div class="text-center">
                <svg
                  class="mx-auto mb-4 text-green-500 w-12 h-12"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M5 13l4 4L19 7"></path>
                </svg>
                <h3 class="mb-5 text-lg font-semibold text-gray-900">
                  Mensaje enviado correctamente
                </h3>
                <p class="text-gray-600 mb-5">
                  Nuestros asesores se pondrán en contacto contigo pronto
                </p>
                <button
                  type="button"
                  class="text-white bg-[#8647EA] hover:bg-[#6d34c7] font-medium rounded-lg text-sm px-5 py-2.5 text-center"
                  id="close-success-message"
                >
                  Aceptar
                </button>
              </div>
            </div>
          </div>

          <div
            class="md:flex hidden flex-row w-1/2 items-center justify-center"
          >
            <Image
              src={imgContact}
              alt={"Contacta a 1nLines"}
              class={"w-[271px] md:w-[280px]"}
            />
          </div>
        </div>
        <div
          class="flex flex-col space-y-2 justify-center items-center pt-5 pb-8"
        >
          <h4>
            Nuestros asesores primero se comunicarán contigo por el medio
            señalado como preferente
          </h4>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Estilos para el modal activo */
  .modal-active .modal-backdrop {
    opacity: 0.5;
  }

  .modal-active .modal-content {
    opacity: 1;
    transform: translateY(0);
  }

  /* Animación para el mensaje de éxito */
  #success-message {
    transition: opacity 0.3s ease-in-out;
  }
</style>

<script>
  import { $ } from "../lib/dom-selector";

  document.addEventListener("DOMContentLoaded", function () {
    const form = $<HTMLFormElement>("#id-dejanos-contactarte form");
    const successMessage = $("#success-message");
    const closeSuccessButton = $("#close-success-message");

    // Manejador para cerrar el mensaje de éxito
    if (closeSuccessButton && successMessage) {
      closeSuccessButton.addEventListener("click", () => {
        // En lugar de usar hidden, manejamos con opacity y pointer-events
        successMessage.classList.add("opacity-0", "pointer-events-none");

        // Cerrar el modal principal también
        const dejanosElement = $("#id-dejanos-contactarte");
        const bodyElement = $("#body-page");
        if (dejanosElement && bodyElement) {
          dejanosElement.classList.remove("flex");
          dejanosElement.classList.add("hidden");
          bodyElement.classList.remove("overflow-hidden");
          bodyElement.classList.add("overflow-auto");
        }
      });
    }

    if (form) {
      form.addEventListener("submit", async function (event) {
        event.preventDefault();

        const nameInput = $<HTMLInputElement>("#name", form);
        const emailInput = $<HTMLInputElement>("#email", form);
        const cellphoneInput = $<HTMLInputElement>("#cellphone", form);
        const contactMethodSelect = $<HTMLSelectElement>(
          "#contactMethod",
          form
        );

        if (
          !nameInput ||
          !emailInput ||
          !cellphoneInput ||
          !contactMethodSelect
        ) {
          console.error("No se encontraron todos los campos del formulario");
          return;
        }

        const formData = {
          name: nameInput.value,
          email: emailInput.value,
          cellphone: cellphoneInput.value,
          contactMethod: contactMethodSelect.value,
          formType: "dejanos-contactarte",
        };

        try {
          const response = await fetch("/api/send-email", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData),
          });

          const data = await response.json();
          console.log("Respuesta del servidor:", data);

          if (response.ok) {
            // Mostrar mensaje de éxito usando opacity
            if (successMessage) {
              successMessage.classList.remove(
                "opacity-0",
                "pointer-events-none"
              );
            }

            // Limpiar el formulario
            form.reset();
            console.log("Formulario limpiado");
          } else {
            throw new Error(data.message || "Error al enviar el mensaje");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error al enviar el mensaje. Por favor, intenta nuevamente.");
        }
      });
    } else {
      console.error("No se encontró el formulario de Déjanos contactarte");
    }
  });
</script>
